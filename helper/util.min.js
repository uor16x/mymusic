const qs=require("querystring"),url=require("url"),Entities=require("html-entities").AllHtmlEntities,FORMATS={5:{container:"flv",resolution:"240p",encoding:"Sorenson H.283",profile:null,bitrate:"0.25",audioEncoding:"mp3",audioBitrate:64},6:{container:"flv",resolution:"270p",encoding:"Sorenson H.263",profile:null,bitrate:"0.8",audioEncoding:"mp3",audioBitrate:64},13:{container:"3gp",resolution:null,encoding:"MPEG-4 Visual",profile:null,bitrate:"0.5",audioEncoding:"aac",audioBitrate:null},17:{container:"3gp",resolution:"144p",encoding:"MPEG-4 Visual",profile:"simple",bitrate:"0.05",audioEncoding:"aac",audioBitrate:24},18:{container:"mp4",resolution:"360p",encoding:"H.264",profile:"baseline",bitrate:"0.5",audioEncoding:"aac",audioBitrate:96},22:{container:"mp4",resolution:"720p",encoding:"H.264",profile:"high",bitrate:"2-3",audioEncoding:"aac",audioBitrate:192},34:{container:"flv",resolution:"360p",encoding:"H.264",profile:"main",bitrate:"0.5",audioEncoding:"aac",audioBitrate:128},35:{container:"flv",resolution:"480p",encoding:"H.264",profile:"main",bitrate:"0.8-1",audioEncoding:"aac",audioBitrate:128},36:{container:"3gp",resolution:"240p",encoding:"MPEG-4 Visual",profile:"simple",bitrate:"0.175",audioEncoding:"aac",audioBitrate:32},37:{container:"mp4",resolution:"1080p",encoding:"H.264",profile:"high",bitrate:"3-5.9",audioEncoding:"aac",audioBitrate:192},38:{container:"mp4",resolution:"3072p",encoding:"H.264",profile:"high",bitrate:"3.5-5",audioEncoding:"aac",audioBitrate:192},43:{container:"webm",resolution:"360p",encoding:"VP8",profile:null,bitrate:"0.5-0.75",audioEncoding:"vorbis",audioBitrate:128},44:{container:"webm",resolution:"480p",encoding:"VP8",profile:null,bitrate:"1",audioEncoding:"vorbis",audioBitrate:128},45:{container:"webm",resolution:"720p",encoding:"VP8",profile:null,bitrate:"2",audioEncoding:"vorbis",audioBitrate:192},46:{container:"webm",resolution:"1080p",encoding:"vp8",profile:null,bitrate:null,audioEncoding:"vorbis",audioBitrate:192},82:{container:"mp4",resolution:"360p",encoding:"H.264",profile:"3d",bitrate:"0.5",audioEncoding:"aac",audioBitrate:96},83:{container:"mp4",resolution:"240p",encoding:"H.264",profile:"3d",bitrate:"0.5",audioEncoding:"aac",audioBitrate:96},84:{container:"mp4",resolution:"720p",encoding:"H.264",profile:"3d",bitrate:"2-3",audioEncoding:"aac",audioBitrate:192},85:{container:"mp4",resolution:"1080p",encoding:"H.264",profile:"3d",bitrate:"3-4",audioEncoding:"aac",audioBitrate:192},100:{container:"webm",resolution:"360p",encoding:"VP8",profile:"3d",bitrate:null,audioEncoding:"vorbis",audioBitrate:128},101:{container:"webm",resolution:"360p",encoding:"VP8",profile:"3d",bitrate:null,audioEncoding:"vorbis",audioBitrate:192},102:{container:"webm",resolution:"720p",encoding:"VP8",profile:"3d",bitrate:null,audioEncoding:"vorbis",audioBitrate:192},133:{container:"mp4",resolution:"240p",encoding:"H.264",profile:"main",bitrate:"0.2-0.3",audioEncoding:null,audioBitrate:null},134:{container:"mp4",resolution:"360p",encoding:"H.264",profile:"main",bitrate:"0.3-0.4",audioEncoding:null,audioBitrate:null},135:{container:"mp4",resolution:"480p",encoding:"H.264",profile:"main",bitrate:"0.5-1",audioEncoding:null,audioBitrate:null},136:{container:"mp4",resolution:"720p",encoding:"H.264",profile:"main",bitrate:"1-1.5",audioEncoding:null,audioBitrate:null},137:{container:"mp4",resolution:"1080p",encoding:"H.264",profile:"high",bitrate:"2.5-3",audioEncoding:null,audioBitrate:null},138:{container:"mp4",resolution:"4320p",encoding:"H.264",profile:"high",bitrate:"13.5-25",audioEncoding:null,audioBitrate:null},160:{container:"mp4",resolution:"144p",encoding:"H.264",profile:"main",bitrate:"0.1",audioEncoding:null,audioBitrate:null},242:{container:"webm",resolution:"240p",encoding:"VP9",profile:"profile 0",bitrate:"0.1-0.2",audioEncoding:null,audioBitrate:null},243:{container:"webm",resolution:"360p",encoding:"VP9",profile:"profile 0",bitrate:"0.25",audioEncoding:null,audioBitrate:null},244:{container:"webm",resolution:"480p",encoding:"VP9",profile:"profile 0",bitrate:"0.5",audioEncoding:null,audioBitrate:null},247:{container:"webm",resolution:"720p",encoding:"VP9",profile:"profile 0",bitrate:"0.7-0.8",audioEncoding:null,audioBitrate:null},248:{container:"webm",resolution:"1080p",encoding:"VP9",profile:"profile 0",bitrate:"1.5",audioEncoding:null,audioBitrate:null},264:{container:"mp4",resolution:"1440p",encoding:"H.264",profile:"high",bitrate:"4-4.5",audioEncoding:null,audioBitrate:null},266:{container:"mp4",resolution:"2160p",encoding:"H.264",profile:"high",bitrate:"12.5-16",audioEncoding:null,audioBitrate:null},271:{container:"webm",resolution:"1440p",encoding:"VP9",profile:"profle 0",bitrate:"9",audioEncoding:null,audioBitrate:null},272:{container:"webm",resolution:"4320p",encoding:"VP9",profile:"profile 0",bitrate:"20-25",audioEncoding:null,audioBitrate:null},278:{container:"webm",resolution:"144p 15fps",encoding:"VP9",profile:"profile 0",bitrate:"0.08",audioEncoding:null,audioBitrate:null},298:{container:"mp4",resolution:"720p",encoding:"H.264",profile:"main",bitrate:"3-3.5",audioEncoding:null,audioBitrate:null},299:{container:"mp4",resolution:"1080p",encoding:"H.264",profile:"high",bitrate:"5.5",audioEncoding:null,audioBitrate:null},302:{container:"webm",resolution:"720p HFR",encoding:"VP9",profile:"profile 0",bitrate:"2.5",audioEncoding:null,audioBitrate:null},303:{container:"webm",resolution:"1080p HFR",encoding:"VP9",profile:"profile 0",bitrate:"5",audioEncoding:null,audioBitrate:null},308:{container:"webm",resolution:"1440p HFR",encoding:"VP9",profile:"profile 0",bitrate:"10",audioEncoding:null,audioBitrate:null},313:{container:"webm",resolution:"2160p",encoding:"VP9",profile:"profile 0",bitrate:"13-15",audioEncoding:null,audioBitrate:null},315:{container:"webm",resolution:"2160p HFR",encoding:"VP9",profile:"profile 0",bitrate:"20-25",audioEncoding:null,audioBitrate:null},330:{container:"webm",resolution:"144p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"0.08",audioEncoding:null,audioBitrate:null},331:{container:"webm",resolution:"240p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"0.1-0.15",audioEncoding:null,audioBitrate:null},332:{container:"webm",resolution:"360p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"0.25",audioEncoding:null,audioBitrate:null},333:{container:"webm",resolution:"240p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"0.5",audioEncoding:null,audioBitrate:null},334:{container:"webm",resolution:"720p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"1",audioEncoding:null,audioBitrate:null},335:{container:"webm",resolution:"1080p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"1.5-2",audioEncoding:null,audioBitrate:null},336:{container:"webm",resolution:"1440p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"5-7",audioEncoding:null,audioBitrate:null},337:{container:"webm",resolution:"2160p HDR, HFR",encoding:"VP9",profile:"profile 2",bitrate:"12-14",audioEncoding:null,audioBitrate:null},139:{container:"mp4",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"aac",audioBitrate:48},140:{container:"m4a",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"aac",audioBitrate:128},141:{container:"mp4",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"aac",audioBitrate:256},171:{container:"webm",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"vorbis",audioBitrate:128},172:{container:"webm",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"vorbis",audioBitrate:192},249:{container:"webm",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"opus",audioBitrate:48},250:{container:"webm",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"opus",audioBitrate:64},251:{container:"webm",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"opus",audioBitrate:160},91:{container:"ts",resolution:"144p",encoding:"H.264",profile:"main",bitrate:"0.1",audioEncoding:"aac",audioBitrate:48},92:{container:"ts",resolution:"240p",encoding:"H.264",profile:"main",bitrate:"0.15-0.3",audioEncoding:"aac",audioBitrate:48},93:{container:"ts",resolution:"360p",encoding:"H.264",profile:"main",bitrate:"0.5-1",audioEncoding:"aac",audioBitrate:128},94:{container:"ts",resolution:"480p",encoding:"H.264",profile:"main",bitrate:"0.8-1.25",audioEncoding:"aac",audioBitrate:128},95:{container:"ts",resolution:"720p",encoding:"H.264",profile:"main",bitrate:"1.5-3",audioEncoding:"aac",audioBitrate:256},96:{container:"ts",resolution:"1080p",encoding:"H.264",profile:"high",bitrate:"2.5-6",audioEncoding:"aac",audioBitrate:256},120:{container:"flv",resolution:"720p",encoding:"H.264",profile:"Main@L3.1",bitrate:"2",audioEncoding:"aac",audioBitrate:128},127:{container:"ts",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"aac",audioBitrate:96},128:{container:"ts",resolution:null,encoding:null,profile:null,bitrate:null,audioEncoding:"aac",audioBitrate:96},132:{container:"ts",resolution:"240p",encoding:"H.264",profile:"baseline",bitrate:"0.15-0.2",audioEncoding:"aac",audioBitrate:48},151:{container:"ts",resolution:"720p",encoding:"H.264",profile:"baseline",bitrate:"0.05",audioEncoding:"aac",audioBitrate:24}},VIDEO_URL="https://www.youtube.com/watch?v=";var timeRegexp=/(?:(\d+)h)?(?:(\d+)m(?!s))?(?:(\d+)s)?(?:(\d+)(?:ms)?)?/;exports.parseTime=(i=>{var e=timeRegexp.exec(i.toString()),n=e[1]||0,o=e[2]||0,t=e[3]||0,r=e[4]||0;return 36e5*n+6e4*o+1e3*t+parseInt(r,10)});var audioEncodingRanks={mp3:1,vorbis:2,aac:3,opus:4,flac:5},videoEncodingRanks={"Sorenson H.283":1,"MPEG-4 Visual":2,VP8:3,VP9:4,"H.264":5};exports.sortFormats=((i,e)=>{var n=i.resolution?parseInt(i.resolution.slice(0,-1),10):0,o=e.resolution?parseInt(e.resolution.slice(0,-1),10):0,t=2*~~!!n+~~!!i.audioBitrate,r=2*~~!!o+~~!!e.audioBitrate;function a(i){if(i.bitrate){let e=i.bitrate.split("-");return parseFloat(e[e.length-1],10)}return 0}function l(i){return(i.audioBitrate||0)+(audioEncodingRanks[i.audioEncoding]||0)/10}if(t===r){if(n===o){let n=a(i),o=a(e);if(n===o){let n=l(i),o=l(e);if(n===o){let n=videoEncodingRanks[i.encoding]||0;return(videoEncodingRanks[e.encoding]||0)-n}return o-n}return o-n}return o-n}return r-t}),exports.chooseFormat=((i,e)=>{if("object"==typeof e.format)return e.format;if(e.filter&&0===(i=exports.filterFormats(i,e.filter)).length)return new Error("No formats found with custom filter");var n,o=e.quality||"highest";function t(i){let e=i.bitrate.split("-");return parseFloat(e[e.length-1],10)}switch(o){case"highest":n=i[0];break;case"lowest":n=i[i.length-1];break;case"highestaudio":i=exports.filterFormats(i,"audio"),n=null;for(let e of i)(!n||e.audioBitrate>n.audioBitrate||e.audioBitrate===n.audioBitrate&&n.encoding&&!e.encoding)&&(n=e);break;case"highestvideo":i=exports.filterFormats(i,"video"),n=null;for(let e of i)(!n||t(e)>t(n)||t(e)===t(n)&&n.audioEncoding&&!e.audioEncoding)&&(n=e);break;default:{let e=e=>i.find(i=>i.itag===""+e);Array.isArray(o)?o.find(i=>n=e(i)):n=e(o)}}return n||new Error("No such format found: "+o)}),exports.filterFormats=((i,e)=>{var n;switch(e){case"audioandvideo":n=(i=>i.bitrate&&i.audioBitrate);break;case"video":n=(i=>i.bitrate);break;case"videoonly":n=(i=>i.bitrate&&!i.audioBitrate);break;case"audio":n=(i=>i.audioBitrate);break;case"audioonly":n=(i=>!i.bitrate&&i.audioBitrate);break;default:if("function"!=typeof e)throw new TypeError(`Given filter (${e}) is not supported`);n=e}return i.filter(n)}),exports.between=((i,e,n)=>{var o;return-1===(o=i.indexOf(e))?"":-1===(o=(i=i.slice(o+e.length)).indexOf(n))?"":i=i.slice(0,o)}),exports.getURLVideoID=function(i){var e=url.parse(i,!0),n=e.query.v;if("youtu.be"===e.hostname||("youtube.com"===e.hostname||"www.youtube.com"===e.hostname)&&!n){var o=e.pathname.split("/");n=o[o.length-1]}return n?(n=n.substring(0,11),exports.validateID(n)?n:new TypeError(`Video id (${n}) does not match expected `+`format (${idRegex.toString()})`)):new Error("No video id found: "+i)},exports.getVideoID=(i=>exports.validateID(i)?i:exports.getURLVideoID(i));var idRegex=/^[a-zA-Z0-9-_]{11}$/;exports.validateID=(i=>idRegex.test(i)),exports.validateURL=(i=>!(exports.getURLVideoID(i)instanceof Error)),exports.parseFormats=(i=>{var e=[];return i.url_encoded_fmt_stream_map&&(e=e.concat(i.url_encoded_fmt_stream_map.split(","))),i.adaptive_fmts&&(e=e.concat(i.adaptive_fmts.split(","))),e=e.map(i=>qs.parse(i)),delete i.url_encoded_fmt_stream_map,delete i.adaptive_fmts,e}),exports.addFormatMeta=(i=>{var e=FORMATS[i.itag];for(let n in e)i[n]=e[n];/\/live\/1\//.test(i.url)&&(i.live=!0)}),exports.stripHTML=(i=>i.replace(/\n/g," ").replace(/\s*<\s*br\s*\/?\s*>\s*/gi,"\n").replace(/<\s*\/\s*p\s*>\s*<\s*p[^>]*>/gi,"\n").replace(/<.*?>/gi,"").trim()),exports.getVideoDescription=(i=>{var e=i.match(/<p.*?id="eow-description".*?>(.+?)<\/p>[\n\r\s]*?<\/div>/im);return e?(new Entities).decode(exports.stripHTML(e[1])):""});var authorRegexp=/<a href="\/channel\/([\w-]+)"[^>]+>(.+?(?=<\/a>))/,aliasRegExp=/<a href="\/user\/([^"]+)/;exports.getAuthor=(i=>{var e=exports.between(i,'<div id="watch7-user-header" class=" spf-link ">','<div id="watch8-action-buttons" class="watch-action-buttons clearfix">');if(""===e)return{};var n=(e=(new Entities).decode(e)).match(authorRegexp),o=e.match(aliasRegExp);return{id:n[1],name:n[2],avatar:url.resolve(VIDEO_URL,exports.between(e,'data-thumb="','"')),user:o?o[1]:null,channel_url:"https://www.youtube.com/channel/"+n[1],user_url:o?"https://www.youtube.com/user/"+o[1]:null}}),exports.getPublished=(i=>Date.parse(exports.between(i,'<meta itemprop="datePublished" content="','">'))),exports.getRelatedVideos=(i=>{var e=exports.between(i,"'RELATED_PLAYER_ARGS': {\"rvs\":","},");try{e=JSON.parse(e)}catch(i){return[]}return e.split(",").map(i=>qs.parse(i))}),exports.parallel=((i,e)=>{var n=0,o=i.length,t=!1,r=[];o>0?i.forEach((i,a)=>{i(function(i,a,l){if(!t){if(a)return t=!0,void e(a);r[i]=l,++n===o&&e(null,r)}}.bind(null,a))}):e(null,r)});var numberFormat=/^\d+$/,timeFormat=/^(?:(?:(\d+):)?(\d{1,2}):)?(\d{1,2})(?:\.(\d{3}))?$/,timeUnits={ms:1,s:1e3,m:6e4,h:36e5};exports.fromHumanTime=(i=>{if("number"==typeof i)return i;if(numberFormat.test(i))return+i;var e=timeFormat.exec(i);if(e)return+(e[1]||0)*timeUnits.h+ +(e[2]||0)*timeUnits.m+ +e[3]*timeUnits.s+ +(e[4]||0);for(var n,o=0,t=/(\d+)(ms|s|m|h)/g;null!=(n=t.exec(i));)o+=+n[1]*timeUnits[n[2]];return o});